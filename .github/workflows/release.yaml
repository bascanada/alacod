name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build & Release
    runs-on: [self-hosted, alacod-builder]
    environment: production
    permissions:
      contents: write
    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login docker
        run: docker login https://ghcr.io -u wquintal -p $GITHUB_ACCESS_TOKEN
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Build WASM in container
        run: |
          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "${{ github.workspace }}:/workspace" \
            -e CARGO_HOME=/cargo \
            -v "$HOME/.cargo/registry:/cargo/registry" \
            -v "$HOME/.cargo/git:/cargo/git" \
            -e SCCACHE_DIR=/sccache \
            -v "$HOME/.cache/sccache:/sccache" \
            -w /workspace \
            -e RUSTC_WRAPPER=sccache \
            -e CARGO_INCREMENTAL=0 \
            ghcr.io/bascanada/alacod-builder:1.0.0 \
            bash -c "cargo vendor && make build_docker_website TARGET=web PROFILE=prod"

      - name: Push docker website
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -w /workspace \
            -e GITHUB_ACCESS_TOKEN=${{ secrets.ACCESS_TOKEN }} \
            ghcr.io/bascanada/alacod-builder:1.0.0 \
            bash -c "docker login https://ghcr.io -u wquintal -p \$GITHUB_ACCESS_TOKEN && make push_docker_website"

      - name: Export build files
        run: |
          VERSION=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "$(git describe --tags --abbrev=0 2>/dev/null || echo 'v0.0.0')-$(git rev-parse --short HEAD)")
          docker create --name $VERSION ghcr.io/bascanada/alacod:latest
          docker cp $VERSION:/usr/share/nginx/html ./build
          docker rm $VERSION

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: 'alacod'
          directory: './build'

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        with:
          generate_release_notes: true
