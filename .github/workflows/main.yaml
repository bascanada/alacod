name: Build & Deploy

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Tests & Format
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/bascanada/alacod-builder:latest
      credentials:
        username: wquintal
        password: ${{ secrets.ACCESS_TOKEN }}
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Cache cargo registry and git
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-

      - name: Test
        run: make test

      - name: Style Check
        run: make format

  build:
    name: Build WASM & Deploy
    runs-on: [self-hosted, alacod-builder]
    needs: test
    environment: production
    steps:
      - name: Clean workspace
        run: |
          # Remove build artifacts with proper permissions
          if [ -d "${{ github.workspace }}/target_wasm_prod" ]; then
            chmod -R u+w "${{ github.workspace }}/target_wasm_prod" || true
            rm -rf "${{ github.workspace }}/target_wasm_prod" || true
          fi
          # Clean any other target directories
          find "${{ github.workspace }}" -type d -name "target*" -exec chmod -R u+w {} \; 2>/dev/null || true
          find "${{ github.workspace }}" -type d -name "target*" -exec rm -rf {} \; 2>/dev/null || true
        continue-on-error: true

      - name: Check out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Login docker
        run: docker login https://ghcr.io -u wquintal -p $GITHUB_ACCESS_TOKEN
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Build WASM in container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v "$HOME/.cargo/registry:/root/.cargo/registry" \
            -v "$HOME/.cargo/git:/root/.cargo/git" \
            -v "$HOME/.cache/sccache:/root/.cache/sccache" \
            -w /workspace \
            -e SCCACHE_DIR=/root/.cache/sccache \
            -e RUSTC_WRAPPER=sccache \
            -e CARGO_INCREMENTAL=0 \
            ghcr.io/bascanada/alacod-builder:latest \
            bash -c "cargo vendor && make build_docker_website TARGET=web PROFILE=prod"

      - name: Push docker website
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -w /workspace \
            -e GITHUB_ACCESS_TOKEN=${{ secrets.ACCESS_TOKEN }} \
            ghcr.io/bascanada/alacod-builder:latest \
            bash -c "docker login https://ghcr.io -u wquintal -p \$GITHUB_ACCESS_TOKEN && make push_docker_website"

      - name: Export build files
        run: |
          VERSION=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "$(git describe --tags --abbrev=0 2>/dev/null || echo 'v0.0.0')-$(git rev-parse --short HEAD)")
          docker create --name $VERSION ghcr.io/bascanada/alacod:latest
          docker cp $VERSION:/usr/share/nginx/html ./build
          docker rm $VERSION

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: 'alacod'
          directory: './build'

      - name: Cleanup build artifacts
        if: always()
        run: |
          # Clean up target directories after build
          chmod -R u+w "${{ github.workspace }}/target_wasm_prod" 2>/dev/null || true
          rm -rf "${{ github.workspace }}/target_wasm_prod" || true
          rm -rf "${{ github.workspace }}/build" || true
        continue-on-error: true
