name: Build & Deploy

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Tests & Format
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/bascanada/alacod-builder:1.0.0
      credentials:
        username: wquintal
        password: ${{ secrets.ACCESS_TOKEN }}
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Cache cargo registry and git
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-

      - name: Test
        run: make test

      - name: Style Check
        run: make format

  build:
    name: Build WASM & Deploy
    runs-on: [self-hosted, alacod-builder]
    needs: test
    environment: production
    steps:
      - name: Clean workspace with sudo
        run: |
          if [ -d "${{ github.workspace }}" ]; then
            sudo chown -R $USER:$USER ${{ github.workspace }}
          fi
      - name: Check out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Login docker
        run: docker login https://ghcr.io -u wquintal -p $GITHUB_ACCESS_TOKEN
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      - name: Fix host cache permissions
        run: |
          # Use a root container to chown the host's cache directories back to the current user
          docker run --rm \
            -v "$HOME/.cargo:/cargo_cache" \
            -v "$HOME/.cache/sccache:/sccache_cache" \
            ghcr.io/bascanada/alacod-builder:1.0.0 \
            bash -c "chown -R $(id -u):$(id -g) /cargo_cache /sccache_cache"
      - name: Build WASM in container
        run: |
          # 1. Get the Group ID (GID) of the docker socket
          DOCKER_GID=$(stat -c '%g' /var/run/docker.sock)

          docker run --rm \
            -u "$(id -u):$(id -g)" \
            --group-add "$DOCKER_GID" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -e HOME=/tmp \
            ghcr.io/bascanada/alacod-builder:1.0.0 \
            docker version

          docker run --rm \
            -u "$(id -u):$(id -g)" \
            --group-add "$DOCKER_GID" \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -e HOME=/tmp \
            -e CARGO_HOME=/cargo \
            -v "$HOME/.cargo/registry:/cargo/registry" \
            -v "$HOME/.cargo/git:/cargo/git" \
            -e SCCACHE_DIR=/sccache \
            -v "$HOME/.cache/sccache:/sccache" \
            -w /workspace \
            -e RUSTC_WRAPPER=sccache \
            -e CARGO_INCREMENTAL=0 \
            ghcr.io/bascanada/alacod-builder:1.0.0 \
            bash -c "cargo vendor && make build_docker_website TARGET=web PROFILE=prod"

      - name: Push docker website
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            --group-add "$DOCKER_GID" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -w /workspace \
            -e GITHUB_ACCESS_TOKEN=${{ secrets.ACCESS_TOKEN }} \
            ghcr.io/bascanada/alacod-builder:1.0.0 \
            bash -c "docker login https://ghcr.io -u wquintal -p \$GITHUB_ACCESS_TOKEN && make push_docker_website"

      - name: Export build files
        run: |
          VERSION=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "$(git describe --tags --abbrev=0 2>/dev/null || echo 'v0.0.0')-$(git rev-parse --short HEAD)")
          docker create --name $VERSION ghcr.io/bascanada/alacod:latest
          docker cp $VERSION:/usr/share/nginx/html ./build
          docker rm $VERSION

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: 'alacod'
          directory: './build'

      - name: Cleanup build artifacts
        if: always()
        run: |
          # Clean up target directories after build
          chmod -R u+w "${{ github.workspace }}/target_wasm_prod" 2>/dev/null || true
          rm -rf "${{ github.workspace }}/target_wasm_prod" || true
          rm -rf "${{ github.workspace }}/build" || true
        continue-on-error: true
